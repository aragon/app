# Hotfix Start â€” creates a hotfix branch + PR from a tag (default: latest tag)

name: Hotfix Start

on:
  workflow_dispatch:
    inputs:
      base_tag:
        description: "Tag to hotfix from (default: latest tag)"
        required: false
        type: string
      commits:
        description: "Commit SHAs to cherry-pick from main (comma/space/newline separated)"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  start:
    runs-on: ubuntu-latest
    steps:
      - name: Load secrets
        id: load-secrets
        uses: 1password/load-secrets-action@v3.1.0
        with:
          export-env: false
        env:
          OP_SERVICE_ACCOUNT_TOKEN: '${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}'
          GPG_PASSPHRASE: op://kv_app_infra/arabot-1_SIGN_CERTS/credential
          GPG_PRIVATE_KEY: op://kv_app_infra/arabot-1_SIGN_CERTS/private_key
          ARABOT_PAT: op://kv_app_infra/ARABOT_PAT/credential
          SLACK_BOT_TOKEN: op://kv_app_infra/SLACK_BOT_TOKEN/credential
          SLACK_CHANNEL_ID: op://kv_app_infra/SLACK_CHANNEL_ID/credential

      - name: Checkout actions
        uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 1
          sparse-checkout: |
            .github/actions
            .github/workflows/scripts/slackNotify.js

      - name: Setup
        uses: ./.github/actions/setup
        with:
          token: ${{ steps.load-secrets.outputs.ARABOT_PAT }}
          fetch-depth: 0
          ref: ${{ inputs.base_tag || 'main' }}

      - name: Detect base tag (if not provided)
        id: base
        shell: bash
        run: |
          git fetch --tags --force >/dev/null 2>&1 || true
          if [ -n "${{ inputs.base_tag }}" ]; then
            echo "tag=${{ inputs.base_tag }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          TAG="$(git describe --tags --abbrev=0 2>/dev/null || true)"
          if [ -z "$TAG" ]; then
            echo "No tags found and base_tag not provided." >&2
            exit 1
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Generate hotfix branch name
        id: branch
        shell: bash
        run: echo "name=hotfix/${{ steps.base.outputs.tag }}_$(date +'%Y-%m-%d_%H-%M')" >> "$GITHUB_OUTPUT"

      - name: Ensure hotfix branch from tag
        uses: ./.github/actions/git-ensure-branch
        with:
          branch: ${{ steps.branch.outputs.name }}
          base_ref: ${{ steps.base.outputs.tag }}

      - name: Checkout hotfix branch
        shell: bash
        run: |
          git checkout "${{ steps.branch.outputs.name }}"

      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6.3.0
        with:
          gpg_private_key: ${{ steps.load-secrets.outputs.GPG_PRIVATE_KEY }}
          passphrase: ${{ steps.load-secrets.outputs.GPG_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Cherry-pick selected commits from main
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin main --force >/dev/null 2>&1 || true

          RAW="${{ inputs.commits }}"
          # normalize separators to newlines
          COMMITS="$(printf "%s" "$RAW" | tr ', ' '\n\n' | sed '/^$/d')"
          if [ -z "$COMMITS" ]; then
            echo "No commits provided." >&2
            exit 1
          fi

          echo "Cherry-picking:"
          echo "$COMMITS"

          while IFS= read -r sha; do
            [ -z "$sha" ] && continue
            git cherry-pick -x "$sha"
          done <<< "$COMMITS"

      - name: Update version and changelog (hotfix start)
        uses: ./.github/actions/changeset-version
        with:
          prettier_changelog: "true"
          github_token: ${{ steps.load-secrets.outputs.ARABOT_PAT }}

      - name: Commit & push (hotfix)
        id: push
        shell: bash
        run: |
          set -euo pipefail
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes detected after cherry-pick + version. Did you include the right commits and/or changesets?" >&2
            exit 1
          fi
          VERSION="$(node -p "require('./package.json').version")"
          git add --all
          git commit -m "Hotfix v${VERSION}"
          git push origin "HEAD:${{ steps.branch.outputs.name }}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Ensure Pull Request
        id: pr
        uses: ./.github/actions/gh-ensure-pr
        with:
          base: main
          head: ${{ steps.branch.outputs.name }}
          title: Hotfix v${{ steps.push.outputs.version }} (from ${{ steps.base.outputs.tag }})
          body: |
            Hotfix started from `${{ steps.base.outputs.tag }}`.

            - Cherry-pick required commits into `${{ steps.branch.outputs.name }}`
            - Deploy to staging and test
            - Approve + add label `release:ready` to tag and deploy
          token: ${{ steps.load-secrets.outputs.ARABOT_PAT }}

      - name: Notify Slack
        id: slack
        if: steps.load-secrets.outputs.SLACK_BOT_TOKEN != ''
        uses: ./.github/actions/slack-notify
        with:
          slack_bot_token: ${{ steps.load-secrets.outputs.SLACK_BOT_TOKEN }}
          slack_channel_id: ${{ steps.load-secrets.outputs.SLACK_CHANNEL_ID }}
          message: |
            ðŸ©¹ *Hotfix Started*
            *Base Tag:* `${{ steps.base.outputs.tag }}`
            *Version:* `${{ steps.push.outputs.version }}`
            *PR:* ${{ steps.pr.outputs.url }}

      - name: Update PR with Slack TS
        if: steps.slack.outputs.ts != ''
        uses: ./.github/actions/gh-pr-edit-body
        with:
          pr_number: ${{ steps.pr.outputs.number }}
          token: ${{ steps.load-secrets.outputs.ARABOT_PAT }}
          body: |
            Hotfix started from `${{ steps.base.outputs.tag }}`.

            - Cherry-pick required commits into `${{ steps.branch.outputs.name }}`
            - Deploy to staging and test
            - Approve + add label `release:ready` to tag and deploy

            <!-- slack_ts: ${{ steps.slack.outputs.ts }} -->

